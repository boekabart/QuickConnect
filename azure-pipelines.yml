# ASP.NET Core (.NET Framework)
# Build and test ASP.NET Core projects targeting the full .NET Framework.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

strategy:
  matrix:
    linux:
      imageName: 'ubuntu-latest'
    mac:
      imageName: 'macos-latest'
    windows:
      imageName: 'windows-latest'

pool:
  vmImage: $(imageName)

trigger:
  branches:
    include:
    - develop
    - feature/*
    - hotfix/*
    - release/*
    - master

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'choco install codecov'
  displayName: Install codecov

- task: DotNetCoreInstaller@0
  inputs:
    packageType: 'sdk'
    version: '2.2.401'
  env:
   DOTNET_CLI_TELEMETRY_OPTOUT: false
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install .NET Core 2 latest
  
- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: true
    script: 'dotnet tool install --global coverlet.console'
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install coverlet

- task: PowerShell@2
  condition: ne(variables['Build.SourceBranchName'], 'merge')
  inputs:
    targetType: inline
    pwsh: true
    script: 'dotnet tool install --global git-flow-version'
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install git-flow-version

- task: NuGetToolInstaller@1
  inputs:
    versionSpec: '5.1.0'
    checkLatest: true
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install NuGet

- task: InstallSSHKey@0
  condition: eq(variables.imageName, 'ubuntu-latest')
  inputs:
    knownHostsEntry: 'github.com, ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ=='
    sshPublicKey: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCterE2qLZaFr+ztQna2uu8rKO/hXuxOV0KL1+JerXfLSG1rkIiVptUrwbZNgQjoVCxZd8ounyTCVqIlv3OWmHACfNAlJvNvQFeNZOpbZHiNXxa/sKDGUm/cGcs56rBo2EI9CGhGWbkFV8d5KREAYZn8dbka2ZlHrWlCIt98Ac31KQN75H3anwQJIZ9/E+ZHK8HRF7YY0zAjZB30JcitE0SoAgialGAIDjwua4JeyuzRy4yH9BR42pDKlECUY+eB6b/7El3uPKBVESyGY0dNBYIdOkzEWrmm+EnqcuupjgmNgpWl+wnmJZM72cUUJCfnXl1LcoltfWlIDXaryDyJpPQVNWsnvIVOPQ1HHdfoTtsdp4PhCQbZ8Cj7Y63ptkkWY5v8b6PRqKErdT9hNiOKkBkAP4Of29PQE32smPFBbrZUe86lzj91E0wo8dY2l/G2GMHVGwpwMbOSn0X5mYywzu6r6BuLcL2v0C6wjtBVn9/4Ak6UYXZZcYmYRF08qJDMMX8EMmTXCqdhLPwMwIQw3XT8USgHj1/tlF2TAOwSNX6SBdneiFd4O3Ph7kzbWBGVbM5CMTytPrqPRcEzLoZLk6m0bldJCq+DwkKiJqKZYSz/W3EQwRUelNAsTsYwwSzB2oyejcDkuGEKcxPZgg5KrwCHANq3u+9db7zCbuOw8ptzw== azure-pipeline'
    sshKeySecureFile: 'Tring_gitKey'
  displayName: Install sshKey for documentation publishing
  
- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    feedsToUse: 'select'
  displayName: Dotnet Restore

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'New-Item -ItemType Directory "built"'
  displayName: Create built folder

- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    arguments: '/p:CollectCoverage=true /p:Exclude=[xunit.*]* /p:CoverletOutput=''../../built/Tring.xml'' /p:CoverletOutputFormat=cobertura'
    testRunTitle: 'Running tests'
  displayName: Running Tests

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'codecov -f "./built/Tring.xml" -t $env:CodecovToken'
  env:
    CodecovToken: $(Codecov)
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Publish code coverage

- task: PowerShell@2
  condition: ne(variables['Build.SourceBranchName'], 'merge')
  inputs:
    targetType: 'inline'
    script: |
      $version= git-flow-version --branch $env:BUILD_SOURCEBRANCHNAME | ConvertFrom-Json
      Write-Host "calculated version:"
      $version | Format-List
      echo "##vso[task.setvariable variable=SemVer]$($version.SemVer)"
      echo "##vso[task.setvariable variable=FullSemVer]$($version.FullSemVer)"
      echo "##vso[task.setvariable variable=AssemblyVersion]$($version.AssemblyVersion)"
  displayName: Calculating version

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: 'inline'
    script: |
      $assemblyInfoContent = @"
      // <auto-generated/>
      using System.Reflection;
      using System.Runtime.InteropServices;

      [assembly: AssemblyVersionAttribute("$($env:AssemblyVersion)")]
      [assembly: AssemblyFileVersionAttribute("$($env:AssemblyVersion)")]
      [assembly: AssemblyInformationalVersionAttribute("$($env:FullSemVer)")]
      "@
      $assemblyInfoContent | Out-File -Encoding utf8 (Join-Path "built" "SharedAssemblyInfo.cs") -Force
  env:
    FullSemVer: $(FullSemVer)
    SemVer: $(SemVer)
    AssemblyVersion: $(AssemblyVersion)
  displayName: Create assembly info

- task: DotNetCoreCLI@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    command: 'pack'
    packagesToPack: './src/*/*.csproj'
    packDirectory: './built'
    versioningScheme: 'byEnvVar'
    versionEnvVar: 'FullSemVer'
  displayName: Creating packages dotnet task

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'ubuntu-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: 'inline'
    script: |
      if (Test-Path "./.git/refs/tags/$($env:SemVer)") {
      Write-Host "Tag: $($env:SemVer) is already pressent in the repository!"
      }
      else
      {
      git remote set-url origin git@github.com:hightechict/Tring.git
      git tag $env:SemVer
      git push --verbose origin $env:SemVer
      }
    errorActionPreference: 'continue'
  env:
    SemVer: $(SemVer)
  displayName: Tagging build

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),not(contains(variables['Build.SourceBranch'],'/feature/')),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: 'inline'
    script: |
      Write-Host "Publishing NuGet package"
      pushd built
      dotnet nuget push *.nupkg --api-key $env:NuGet_APIKEY --no-symbols true --source https://api.nuget.org/v3/index.json
      popd
  env:
    NuGet_APIKEY: $(nuget.APIKEY)
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Pushing NuGet package