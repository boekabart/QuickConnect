# ASP.NET Core (.NET Framework)
# Build and test ASP.NET Core projects targeting the full .NET Framework.
# Add steps that publish symbols, save build artifacts, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

strategy:
  matrix:
    linux:
      imageName: 'ubuntu-latest'
    mac:
      imageName: 'macos-latest'
    windows:
      imageName: 'windows-latest'

pool:
  vmImage: $(imageName)

trigger:
  branches:
    include:
    - develop
    - feature/*
    - hotfix/*
    - release/*
    - master

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

steps:

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'choco install codecov'
  displayName: Install codecov

- task: DotNetCoreInstaller@0
  inputs:
    packageType: 'sdk'
    version: '2.2.401'
  displayName: Install .NET Core 2 latest
  env:
   DOTNET_CLI_TELEMETRY_OPTOUT: false
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

- task: PowerShell@2
  inputs:
    targetType: inline
    pwsh: true
    script: 'dotnet tool install --global coverlet.console'
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install coverlet

- task: PowerShell@2
  condition: ne(variables['Build.SourceBranchName'], 'merge')
  inputs:
    targetType: inline
    pwsh: true
    script: 'dotnet tool install --global git-flow-version'
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install git-flow-version

- task: NuGetToolInstaller@1
  inputs:
    versionSpec: '5.1.0'
    checkLatest: true
  env:
   DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Install NuGet

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    feedsToUse: 'select'
  displayName: Dotnet Restore

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'New-Item -ItemType Directory "built"'
  displayName: Create built folder

- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    arguments: '/p:CollectCoverage=true /p:Exclude=[xunit.*]* /p:CoverletOutput=''../../built/Tring.xml'' /p:CoverletOutputFormat=cobertura'
    testRunTitle: 'Running tests'
  displayName: Running Tests

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    targetType: inline
    pwsh: true
    script: 'codecov -f "./built/Tring.xml" -t $env:CodecovToken'
  env:
    CodecovToken: $(CodecovToken)
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  displayName: Publish code coverage

- task: PowerShell@2
  condition: ne(variables['Build.SourceBranchName'], 'merge')
  displayName: Calculating version
  inputs:
    targetType: 'inline'
    script: |
      $version= git-flow-version --branch $env:BUILD_SOURCEBRANCHNAME | ConvertFrom-Json
      Write-Host "calculated version:"
      $version | Format-List
      echo "##vso[task.setvariable variable=SemVer]$($version.SemVer)"
      echo "##vso[task.setvariable variable=FullSemVer]$($version.FullSemVer)"
      echo "##vso[task.setvariable variable=AssemblyVersion]$($version.AssemblyVersion)"

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  displayName: Create assembly info
  inputs:
    targetType: 'inline'
    script: |
      $assemblyInfoContent = @"
      // <auto-generated/>
      using System.Reflection;
      using System.Runtime.InteropServices;

      [assembly: AssemblyVersionAttribute("$($env:AssemblyVersion)")]
      [assembly: AssemblyFileVersionAttribute("$($env:AssemblyVersion)")]
      [assembly: AssemblyInformationalVersionAttribute("$($env:FullSemVer)")]
      "@
      $assemblyInfoContent | Out-File -Encoding utf8 (Join-Path "built" "SharedAssemblyInfo.cs") -Force
  env:
    FullSemVer: $(FullSemVer)
    SemVer: $(SemVer)
    AssemblyVersion: $(AssemblyVersion)

- task: DotNetCoreCLI@2
  condition: and(eq(variables.imageName, 'windows-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  inputs:
    command: 'pack'
    packagesToPack: './src/*/*.csproj'
    packDirectory: './built'
    versioningScheme: 'byEnvVar'
    versionEnvVar: 'FullSemVer'
  displayName: Creating packages dotnet task

- task: PowerShell@2
  condition: and(eq(variables.imageName, 'ubuntu-latest'),ne(variables['Build.SourceBranchName'], 'merge'))
  displayName: Tagging build
  inputs:
    targetType: 'inline'
    script: |
      if (Test-Path "./.git/refs/tags/$($env:SemVer)") {
      Write-Host "Tag: $($env:SemVer) is already pressent in the repository!"
      }
      else
      {
      git remote set-url origin git@github.com:hightechict/Tring.git
      git tag $env:SemVer
      git push --verbose origin $env:SemVer
      }
    errorActionPreference: 'continue'
  env:
    SemVer: $(SemVer)
